From 1fbdfe340ec5108a8c5a1dd1db3442aad3d2e55e Mon Sep 17 00:00:00 2001
From: Carlos Garnacho <carlosg@gnome.org>
Date: Thu, 18 Feb 2021 16:12:53 +0100
Subject: [PATCH] gdk/wayland: Look for font settings recursively

Use the infrastructure already available to look up keys, instead.
This does the right thing and looks up the setting across all
sources.

Fixes: https://gitlab.gnome.org/GNOME/gtk/-/issues/3680
---
 gdk/wayland/gdkdisplay-wayland.c | 13 +++----------
 1 file changed, 3 insertions(+), 10 deletions(-)

diff --git a/gdk/wayland/gdkdisplay-wayland.c b/gdk/wayland/gdkdisplay-wayland.c
index 41e8b5f5a7..88fab19d55 100644
--- a/gdk/wayland/gdkdisplay-wayland.c
+++ b/gdk/wayland/gdkdisplay-wayland.c
@@ -1590,15 +1590,11 @@ update_xft_settings (GdkDisplay *display)
     }
   else
     {
-      GSettingsSchemaSource *source;
-      GSettingsSchema *schema;
+      TranslationEntry *entry;
 
-      source = g_settings_schema_source_get_default ();
-      schema = g_settings_schema_source_lookup (source,
-                                                "org.gnome.desktop.interface",
-                                                FALSE);
+      entry = find_translation_entry_by_schema ("org.gnome.desktop.interface", "font-antialiasing");
 
-      if (schema && g_settings_schema_has_key (schema, "font-antialiasing"))
+      if (entry && entry->valid)
         {
           settings = g_hash_table_lookup (display_wayland->settings,
                                           "org.gnome.desktop.interface");
@@ -1622,9 +1618,6 @@ update_xft_settings (GdkDisplay *display)
           order = GSD_FONT_RGBA_ORDER_RGB;
         }
 
-      if (schema)
-        g_settings_schema_unref (schema);
-
       dpi = get_dpi_from_gsettings (display_wayland) * 1024;
     }
 
-- 
2.29.2

